<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simple Jira Templates</title>

<!-- ===== YAML – edit here ===== -->
<script type="text/yaml" id="templatesYaml">
templates:
  "Trouble report Software-3":
    project: "X-3"
    issuetype: "Bug"
    summary: "Bug: <text>"
    description: |
      *Problem description*
      Explain the issue briefly

      *Steps to reproduce*
      Describe the steps you took before encountering the issue
      
      *Expected result*
      Describe the result you expected

  "Trouble Report Software-4":
    project: "X-4"
    issuetype: "Bug"
    summary: "Bug: <text>"
    description: |
      *Problem description*
      Explain the issue briefly

      *Steps to reproduce*
      Describe the steps you took before encountering the issue
      
      *Expected result*
      Describe the result you expected

  "Trouble Report R2D2-droid":
    project: "CCX-3"
    issuetype: "Bug"
    summary: "R2-D2: soundmodule broken"
    description: |
      *Problem description*
      R2-D2 produces unwanted whistling noises during high load.

      *Steps to reproduce*
      1. Start hyperdrive-diagnostics
      2. Activate soundmodule
      3. Observe distortion

      *Expected result*
      Clear, melodic beep-bops without distortion.
    labels: "droid,audio"
    customfield_12345: "SG-5"
    customfield_12346: "HV-1.0"
    environment: ""   # får dynamisk UI (se defaults.dynamic_fields.environment)

defaults:
  baseUrl: "https://mydomain.com"
  endpoint: "init"   # "init" => CreateIssueDetails!init.jspa, "default" => CreateIssue!default.jspa

  # map project name -> pid
  pid:
    "CCX-3": 10302
    "X-3":   10303
    "X-4":   10304

  # valfri ordning (om fältet finns i mallen)
  order: ["issuetype","summary","labels","environment"]

  # back-compat för issuetype
  issuetypes:
    "Bug": 1
    "Epic": 2

  # generiska mappningar per fältnamn
  maps:
    issuetype:
      "Bug": 1
      "Epic": 2
    # example:
    # priority:
    #   "P1": 1
    #   "P2": 2

  # dynamiska fält-UI (endast om fältet finns i mallen)
  dynamic_fields:
    environment:
      lab:   ["LabA","LabB","LabC"]
      node:  ["Node1","Node2","Node3"]
      build: ["Build-Alpha","Build-Beta","Build-Gamma"]
</script>
<!-- ================================= -->

<style>
*{box-sizing:border-box}
body{font:14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;max-width:960px}
.row{display:grid;grid-template-columns:180px 1fr;gap:10px;margin:8px 0;align-items:start}
input,select{padding:8px;width:100%}
.hint{align-self:center;font-size:12px;color:#666}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.urlbox{background:#f6f6f6;padding:10px;border-radius:6px;overflow:auto}
.small{font-size:12px;color:#666}
#errorBox{display:none;background:#fff3f3;border:1px solid #f1c0c0;color:#7a1f1f;padding:10px;border-radius:6px;margin-bottom:10px;white-space:pre-wrap}
#descRendered{
  border:1px solid #ccc;
  padding:10px;
  min-height:60px;
  background:#fafafa;
  border-radius:6px;
  white-space:pre-wrap; /* newline fix */
}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.dynamic-box{border:1px solid rgba(0,0,0,.12);border-radius:8px;padding:8px;background:#fafafa}
.dynamic-box .inline{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.dynamic-box select{min-width:160px}
.dynamic-box input{width:100%}
.dynamic-box .label-top{font-size:12px;color:#555;margin-bottom:4px}
</style>
</head>

<body>
<header>
  <h1 style="margin:0">Simple Jira Templates</h1>
</header>

<div id="errorBox"></div>

<div class="row">
  <label>Template</label>
  <select id="templateSelect"><option value="">— Choose template —</option></select>
</div>

<div class="row">
  <label for="projectName">project</label>
  <input id="projectName" readonly>
</div>

<!-- Ordered fields (from defaults.order) -->
<div id="orderedFieldsTop"></div>

<!-- Description (renderad bold-only) -->
<input type="hidden" id="descriptionRaw">
<div class="row">
  <label>description</label>
  <div id="descRendered" class="small"></div>
</div>

<!-- Remaining fields -->
<div id="dynamicFields"></div>

<div class="actions">
  <button id="openBtn">Open URL in new tab</button>
  <button id="copyBtn">Copy URL</button>
</div>

<div class="urlbox"><div class="small">Generated URL</div><code id="out">—</code></div>

<script>
(function(){
const errorBox = document.getElementById('errorBox');
function showError(e){
  errorBox.style.display='block';
  errorBox.textContent = 'Error:\\n' + (e && e.message ? e.message : String(e));
}

/* --- helpers --- */
function stripQuotes(s){
  s = String(s||'').trim();
  if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'")))
    return s.slice(1,-1);
  return s;
}
function escapeHTML(s){
  return String(s||'').replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function renderBoldOnly(src){
  const esc=escapeHTML(src||'');
  return esc.replace(/(^|[^*])\*([^*\n]+)\*(?!\*)/g,(m,pre,txt)=>pre+'<strong>'+txt+'</strong>');
}

/* --- Minimal YAML parser (block-literals, scalars, inline lists) --- */
function parseYAML(text){
  const lines = text.replace(/\r\n?/g,'\n').split('\n');
  let i=0;
  function indentOf(s){ let n=0; for(const ch of s){ if(ch===' ') n++; else break; } return n; }
  function parseBlock(level){
    const obj = {};
    let pendingKey = null;
    while (i < lines.length){
      let raw = lines[i];
      if(raw == null || raw.trim()==='' || raw.trim().startsWith('#')){ i++; continue; }
      const ind = indentOf(raw);
      if(ind < level) break;
      if(ind > level){
        if(pendingKey!=null){
          obj[pendingKey] = parseBlock(ind);
          pendingKey = null;
          continue;
        }
        break;
      }
      let s = raw.slice(level);

      const m = s.match(/^([^:#]+):\s*(.*)$/);
      if(!m) throw new Error('Invalid YAML line: ' + raw);
      const key = stripQuotes(m[1]);
      let val = m[2];

      if(val === '|'){ // block literal
        i++;
        obj[key] = readBlock(level+2);
        pendingKey = null;
        continue;
      }
      if(val === ''){ // nested object
        pendingKey = key;
        i++;
        continue;
      }
      obj[key] = parseScalar(val.trim());
      pendingKey = null;
      i++;
    }
    return obj;
  }
  function readBlock(level){
    const out = [];
    while(i < lines.length){
      const raw = lines[i];
      const ind = raw.match(/^ */)[0].length;
      if(raw.trim()===''){ out.push(''); i++; continue; }
      if(ind < level) break;
      out.push(raw.slice(level));
      i++;
    }
    return out.join('\n');
  }
  function parseScalar(s){
    if(/^".*"$/.test(s)) return s.slice(1,-1).replace(/\\"/g,'"');
    if(/^'.*'$/.test(s)) return s.slice(1,-1).replace(/''/g,"'");
    if(s==='null') return null;
    if(s==='true') return true;
    if(s==='false') return false;
    if(/^-?\d+(\.\d+)?$/.test(s)) return Number(s);
    if(/^\[.*\]$/.test(s)){
      const inner = s.slice(1,-1).trim();
      if(!inner) return [];
      return inner.split(',').map(x=>parseScalar(x.trim()));
    }
    return stripQuotes(s);
  }
  return parseBlock(0);
}

/* --- App --- */
const $=id=>document.getElementById(id);
const selTemplate=$('templateSelect'),projectName=$('projectName'),
      descRaw=$('descriptionRaw'),descRendered=$('descRendered'),
      orderedTop=$('orderedFieldsTop'),dynFieldsWrap=$('dynamicFields'),out=$('out');

let config={},currentPid='',currentFieldState={};

function clear(el){while(el.firstChild)el.removeChild(el.firstChild);}

function getMapForField(field){
  const d=config.defaults||{},maps=d.maps||{};
  if(field in maps) return maps[field];
  if(field==='issuetype') return maps.issuetype || d.issuetypes || null;
  return null;
}
function getEndpointPath(){
  const ep=(config.defaults?.endpoint||'init').toLowerCase();
  return ep==='default' ? '/secure/CreateIssue!default.jspa'
                        : '/secure/CreateIssueDetails!init.jspa';
}
function renderDescription(t){
  const raw=t.description||'';
  descRaw.value=raw;
  descRendered.innerHTML=renderBoldOnly(raw);
}

/* Renderar EN rad (reglerna: dynamic_fields om fältet finns i mallen; annars map/dropdown/text) */
function renderFieldRowInto(name, value, intoEl){
  if (['project','description'].includes(name)) return;

  const d = config.defaults || {};
  const dynCfgAll = d.dynamic_fields || {};
  const dynCfg = dynCfgAll[name];         // ex. environment: { lab:[..], node:[..], ... }
  const map = getMapForField(name);       // ev. maps[name] / issuetypes
  const mapKeys = map ? Object.keys(map) : [];

  const row = document.createElement('div');
  row.className = 'row';
  const label = document.createElement('label');
  label.textContent = name;
  row.appendChild(label);

  // --- FALL A: fältet finns i mallen OCH har dynamic_fields-config → dynamisk UI
  if (dynCfg && typeof dynCfg === 'object') {
    const box = document.createElement('div');
    box.className = 'dynamic-box';

    // select-grupper
    const top = document.createElement('div');
    top.className = 'label-top';
    top.textContent = 'Choose alternative:';
    box.appendChild(top);

    const bar = document.createElement('div');
    bar.className = 'inline';

    const selects = [];
    Object.keys(dynCfg).forEach(groupKey => {
      const sel = document.createElement('select');
      (dynCfg[groupKey] || []).forEach(v => sel.add(new Option(v, v)));
      bar.appendChild(sel);
      selects.push(sel);
    });
    box.appendChild(bar);

    // manuellt inmatningsfält (komponerat värde), init med YAML-värde om det finns
    const lbl2 = document.createElement('div');
    lbl2.className = 'label-top';
    lbl2.textContent = name;
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = name;

    const compose = () => selects.map(s => s.value).filter(Boolean).join(', ');
    input.value = (value && String(value).trim()) ? String(value) : compose();

    selects.forEach(s => s.addEventListener('change', () => {
      input.value = compose();
      currentFieldState[name].value = input.value;
      updateOut();
    }));
    input.addEventListener('input', () => {
      currentFieldState[name].value = input.value;
      updateOut();
    });

    box.appendChild(lbl2);
    box.appendChild(input);
    row.appendChild(box);

    currentFieldState[name] = { type:'text', value: input.value, map: null };
    intoEl.appendChild(row);
    return;
  }

  // --- FALL B: vanlig map/dropdown/text ---
  if (map && mapKeys.length >= 2) {
    const sel = document.createElement('select');
    mapKeys.forEach(k => sel.add(new Option(`${k} (${map[k]})`, k)));
    sel.value = (value && map[value] != null) ? value : mapKeys[0];
    row.appendChild(sel);
    currentFieldState[name] = { type:'select', value: sel.value, map };
    sel.addEventListener('change', () => { currentFieldState[name].value = sel.value; updateOut(); });
  } else {
    const wrap = document.createElement('div');
    wrap.style.display = 'grid';
    wrap.style.gridTemplateColumns = '1fr auto';
    wrap.style.gap = '8px';

    const inp = document.createElement('input');
    inp.type = 'text';
    inp.value = value || '';

    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.textContent = (map && value && map[value] != null) ? `(${map[value]})` : '';

    wrap.appendChild(inp);
    wrap.appendChild(hint);
    row.appendChild(wrap);

    currentFieldState[name] = { type:'text', value: inp.value, map, hintEl: hint };
    inp.addEventListener('input', () => {
      currentFieldState[name].value = inp.value;
      if (map && map[inp.value] != null) hint.textContent = `(${map[inp.value]})`;
      else hint.textContent = '';
      updateOut();
    });
  }

  intoEl.appendChild(row);
}

/* Renderar alla fält från template (respekterar defaults.order) */
function renderDynamicFieldsFromTemplate(t){
  clear(orderedTop);
  clear(dynFieldsWrap);
  currentFieldState = {};

  const entries = Object.entries(t).filter(([k,_]) => !['project','description'].includes(k));
  const order = (config.defaults?.order) || [];

  // 1) de som finns i order och i mallen
  for (const fname of order) {
    const idx = entries.findIndex(([k]) => k === fname);
    if (idx >= 0) {
      const [k, v] = entries.splice(idx, 1)[0];
      renderFieldRowInto(k, String(v), orderedTop);
    }
  }
  // 2) resten i alfabetisk ordning
  entries.sort((a,b) => a[0].localeCompare(b[0]));
  for (const [k, v] of entries) renderFieldRowInto(k, String(v), dynFieldsWrap);
}

function buildURL(){
  const d=config.defaults||{};
  const base=(d.baseUrl||'').replace(/\/+$/,'');
  const ep=getEndpointPath();
  const p = new URLSearchParams();

  // pid från projektnamn
  if(currentPid) p.set('pid', String(currentPid));

  // description
  if(descRaw.value) p.set('description', descRaw.value);

  // resterande fält
  for (const [name, st] of Object.entries(currentFieldState)) {
    const val = (st.value||'').trim();
    if (!val) continue;

    if (name === 'labels') {
      val.split(',').map(s => s.trim()).filter(Boolean).forEach(l => p.append('labels', l));
      continue;
    }
    const map = st.map;
    if (map && map[val] != null) p.set(name, String(map[val])); // skicka ID
    else p.set(name, val);                                      // skicka text
  }
  return `${base}${ep}?${p.toString()}`;
}

function updateOut(){
  try{
    out.textContent = buildURL() || '—';
  }catch(e){ showError(e); }
}

function applyTemplate(name){
  try{
    const t=config.templates[name]; if(!t) return;
    const d=config.defaults||{};

    // Project -> pid
    const projKey = t.project || '';
    projectName.value = projKey;
    currentPid = (d.pid && d.pid[projKey]!=null) ? d.pid[projKey] : '';

    // Description
    renderDescription(t);

    // Rendera alla fält (ordning + dynamiska regler)
    const reduced = {...t}; delete reduced.project; delete reduced.description;
    renderDynamicFieldsFromTemplate(reduced);

    updateOut();
  }catch(e){ showError(e); }
}

function loadYamlFromTag(){
  try{
    const txt=document.getElementById('templatesYaml').textContent;
    const y=parseYAML(txt);
    config = y.templates ? { defaults: y.defaults||{}, templates: y.templates } : { defaults:{}, templates:y||{} };

    const sel=selTemplate; while(sel.firstChild) sel.removeChild(sel.firstChild);
    sel.add(new Option('— Choose template —',''));
    Object.keys(config.templates).forEach(k=> sel.add(new Option(k,k)));
  }catch(e){ showError(e); }
}

/* Bindings */
document.getElementById('openBtn').onclick=()=>{
  try{
    const u=buildURL(); if(!u) return alert('Missing baseUrl/pid.');
    if(u.length>1800) return alert('URL too long – shorten description/summary.');
    window.open(u,'_blank','noopener,noreferrer');
  }catch(e){ showError(e); }
};
document.getElementById('copyBtn').onclick=async()=>{
  try{
    const u=buildURL(); if(!u) return alert('No URL.');
    if(u.length>1800) return alert('URL too long – shorten description/summary.');
    await navigator.clipboard.writeText(u); alert('URL copied.');
  }catch(e){ showError(e); }
};
selTemplate.onchange=e=>applyTemplate(e.target.value);

/* Init */
loadYamlFromTag();
const first=selTemplate.options[1]?.value; if(first){ selTemplate.value=first; applyTemplate(first); }
updateOut();
})();
</script>
</body>
</html>
